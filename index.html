<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shika-Md-session</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<style>
  :root {
    --primary: #7c4dff;
    --primary-dark: #651fff;
    --dark: #121212;
    --darker: #0a0a0a;
    --light: #e0e0e0;
    --gray: #757575;
    --success: #00e676;
    --danger: #ff5252;
  }

  * { box-sizing: border-box; margin:0; padding:0; }

  body {
    background: linear-gradient(135deg,#1a1a2e,#16213e);
    color:var(--light);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    font-family:'Segoe UI', system-ui, -apple-system, sans-serif;
    line-height:1.6;
    -webkit-font-smoothing:antialiased;
  }

  .container {
    background: rgba(20,20,20,0.8);
    backdrop-filter: blur(10px);
    border-radius:16px;
    padding:2.5rem;
    box-shadow:0 8px 32px rgba(0,0,0,0.3);
    border:1px solid rgba(255,255,255,0.08);
    text-align:center;
    width:100%;
    max-width:420px;
    margin:1rem;
  }

  h1 { color:var(--light); margin-bottom:2rem; font-weight:600; font-size:1.8rem; letter-spacing:0.5px; }

  .session-control { display:flex; align-items:center; justify-content:center; margin-bottom:1.5rem; gap:0.5rem; }
  .custom-session-input, .phone-input { transition:all 0.35s ease; opacity:0; max-height:0; overflow:hidden; margin-bottom:1.5rem; }
  .custom-session-input.active, .phone-input.active { opacity:1; max-height:420px; }

  input[type="text"], input[type="tel"] {
    background: rgba(30,30,30,0.8); border:1px solid rgba(255,255,255,0.1);
    color:var(--light); padding:0.9rem 1.2rem; border-radius:10px; width:100%; font-size:1rem; margin-top:0.5rem;
    transition: all 0.2s ease;
  }
  input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 4px rgba(124,77,255,0.06); }

  .checkbox-container { display:flex; align-items:center; cursor:pointer; user-select:none; }
  .checkbox-container input { margin-right:0.5rem; accent-color:var(--primary); }

  .buttons { display:flex; gap:1rem; justify-content:center; margin-bottom:2rem; flex-wrap:wrap; }
  .btn {
    background:var(--primary); color:white; border:none; padding:0.9rem 1.8rem; border-radius:10px;
    font-size:1rem; cursor:pointer; transition:all 0.2s ease; font-weight:500; box-shadow:0 4px 6px rgba(0,0,0,0.1);
    display:flex; align-items:center; gap:0.5rem; flex:1; min-width:120px; justify-content:center;
  }
  .btn:hover { background:var(--primary-dark); transform:translateY(-2px); }
  .btn-reset { background:var(--danger); }
  .btn-reset:hover { background:#ff1744; }

  .display-area {
    background: linear-gradient(135deg,var(--darker),var(--dark));
    border-radius:14px; padding:2rem; min-height:250px; display:flex; flex-direction:column; justify-content:center; align-items:center;
    border:1px solid rgba(255,255,255,0.05); margin-bottom:1.5rem; position:relative; overflow:hidden;
  }
  .display-area::before { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:radial-gradient(circle, rgba(124,77,255,0.06) 0%, transparent 70%); z-index:0; }

  #qrcode { max-width:100%; height:auto; border-radius:8px; border:12px solid white; box-shadow:0 4px 20px rgba(0,0,0,0.2);
    display:none; position:relative; z-index:1; transition: all 0.35s ease; opacity:0;
  }
  #qrcode.show { display:block; opacity:1; transform:scale(1); }

  .session-id {
    font-family:'Fira Code', monospace; background:rgba(0,0,0,0.3); padding:0.8rem 1.2rem; border-radius:8px;
    display:none; align-items:center; gap:0.8rem; margin-top:1rem; position:relative; z-index:1; border:1px solid rgba(124,77,255,0.12);
  }
  .session-id.active { display:flex; }

  .copy-btn { background:none; border:none; color:var(--gray); cursor:pointer; transition:color .2s; padding:0.3rem; border-radius:4px; }
  .copy-btn:hover { color:var(--light); background:rgba(255,255,255,0.03); }
  .copy-btn.copied { color:var(--success); }

  #pairingCode { font-family:'Fira Code', monospace; font-size:1.4rem; letter-spacing:2px; background:linear-gradient(135deg,var(--darker),var(--dark));
    padding:1rem 1.4rem; border-radius:10px; display:none; font-weight:bold; color:#fff; border:1px solid rgba(124,77,255,0.12);
    box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.35s ease; opacity:0; position:relative; z-index:1;
  }
  #pairingCode.show { display:block; opacity:1; transform:translateY(0); }

  .status { margin-top:1rem; font-size:0.95rem; color:var(--gray); position:relative; z-index:1; max-width:80%; text-align:center; }

  .loading { display:none; flex-direction:column; align-items:center; position:relative; z-index:1; }
  .spinner { width:40px; height:40px; border:3px solid rgba(124,77,255,0.12); border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; margin-bottom:1rem; }

  .input-valid { border-color:var(--success) !important; box-shadow:0 0 0 4px rgba(0,230,118,0.06) !important; }
  .input-invalid { border-color:var(--danger) !important; box-shadow:0 0 0 4px rgba(255,82,82,0.06) !important; }

  .btn:disabled { background:var(--gray) !important; cursor:not-allowed; transform:none !important; opacity:0.8; }

  .session-validation { display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem; font-size:0.85rem; height:20px; }
  .session-validation .mini-spinner { width:16px; height:16px; border:2px solid rgba(255,255,255,0.12); border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; display:none; }
  .session-validation .validation-message { flex:1; }
  .validation-success { color:var(--success); }
  .validation-error { color:var(--danger); }

  @keyframes spin { 0%{ transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }

  @media (max-width:480px) {
    .container { padding:1.5rem; }
    .buttons { flex-direction:column; }
    .btn { width:100%; }
    #pairingCode { font-size:1.1rem; padding:0.8rem 1rem; letter-spacing:1px; }
    #qrcode { border-width:8px; }
  }
</style>

<body>
  <div class="container" role="main" aria-live="polite">
    <h1>Zokou-MD Login</h1>

    <div class="session-control">
      <label class="checkbox-container">
        <input type="checkbox" id="useCustomSession" aria-label="Use a custom session">
        <span>Use a custom session</span>
      </label>
    </div>

    <div class="custom-session-input" id="customSessionInput">
      <input type="text" id="sessionId" placeholder="Enter session ID" aria-label="Session ID">
      <div class="session-validation">
        <div class="mini-spinner"></div>
        <div class="validation-message"></div>
      </div>
    </div>

    <div class="phone-input" id="phoneInput">
      <input type="tel" id="phoneNumber" placeholder="Enter your phone number (8-15 digits)" aria-label="Phone number">
      <button class="btn" id="validatePhone" style="margin-top:0.8rem; width:100%;">
        <i class="fas fa-check"></i> Validate
      </button>
    </div>

    <div class="display-area" aria-live="polite">
      <div class="loading" id="loading">
        <div class="spinner" aria-hidden="true"></div>
        <p>Loading...</p>
      </div>

      <img src="" alt="QR Code" id="qrcode" />

      <div id="pairingCode" aria-hidden="true"></div>

      <div class="session-id" id="sessionIdDisplay" aria-hidden="true">
        <span id="sessionIdText"></span>
        <button class="copy-btn" id="copySessionBtn" title="Copy session id" aria-label="Copy session id">
          <i class="far fa-copy"></i>
        </button>
      </div>

      <p class="status" id="status">Select a login method</p>
    </div>

    <div class="buttons" id="connectionButtons">
      <button id="qrBtn" class="btn" title="Connect with QR code"><i class="fas fa-qrcode"></i> QR Code</button>
      <button id="pairingBtn" class="btn" title="Pair with code"><i class="fas fa-link"></i> Pairing Code</button>
    </div>

    <div class="buttons" id="resetButton" style="display:none;">
      <button id="resetBtn" class="btn btn-reset"><i class="fas fa-sync-alt"></i> Reset</button>
    </div>
  </div>

  <script>
    // Client-side script (robust, reconnecting WS, compatible with server.js)
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const useCustomSession = document.getElementById('useCustomSession');
      const customSessionInput = document.getElementById('customSessionInput');
      const sessionIdInput = document.getElementById('sessionId');
      const qrBtn = document.getElementById('qrBtn');
      const pairingBtn = document.getElementById('pairingBtn');
      const resetBtn = document.getElementById('resetBtn');
      const phoneInput = document.getElementById('phoneInput');
      const phoneNumber = document.getElementById('phoneNumber');
      const validatePhone = document.getElementById('validatePhone');
      const qrcode = document.getElementById('qrcode');
      const pairingCodeEl = document.getElementById('pairingCode');
      const loading = document.getElementById('loading');
      const status = document.getElementById('status');
      const sessionIdDisplay = document.getElementById('sessionIdDisplay');
      const sessionIdText = document.getElementById('sessionIdText');
      const copySessionBtn = document.getElementById('copySessionBtn');
      const connectionButtons = document.getElementById('connectionButtons');
      const resetButton = document.getElementById('resetButton');
      const validationSpinner = document.querySelector('.mini-spinner');
      const validationMessage = document.querySelector('.validation-message');

      // State
      let ws = null;
      let reconnectAttempts = 0;
      let isSessionValid = false;
      let currentConnectionType = null;
      let debounceTimer = null;

      // Build WS url using host (includes port) so it works in dev and prod
      const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      const wsUrl = `${protocol}${window.location.host}`; // e.g. wss://example.com or ws://localhost:3000

      // Create and manage websocket with simple backoff reconnection
      function createWebSocket() {
        try {
          ws = new WebSocket(wsUrl);
        } catch (e) {
          console.error('WebSocket creation failed', e);
          setStatus('Unable to create WebSocket', true);
          scheduleReconnect();
          return;
        }

        ws.addEventListener('open', () => {
          console.log('WebSocket open', wsUrl);
          reconnectAttempts = 0;
          setStatus('Connected to server');
          loading.style.display = 'none';
        });

        ws.addEventListener('message', (ev) => {
          handleWSMessage(ev.data);
        });

        ws.addEventListener('close', (ev) => {
          console.warn('WebSocket closed', ev);
          setStatus('Disconnected from server', true);
          scheduleReconnect();
        });

        ws.addEventListener('error', (err) => {
          console.error('WebSocket error', err);
          setStatus('Server connection error', true);
          // socket will usually close; let close handler handle reconnect
        });
      }

      function scheduleReconnect() {
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30_000); // exponential backoff up to 30s
        console.log(`Reconnecting WS in ${delay} ms`);
        setTimeout(() => {
          createWebSocket();
        }, delay);
      }

      // Ensure we start WS
      createWebSocket();

      // Safe send helper
      function sendIfOpen(obj) {
        try {
          if (!ws || ws.readyState !== WebSocket.OPEN) {
            console.warn('WS not open, cannot send', obj);
            setStatus('Not connected to server', true);
            return false;
          }
          ws.send(JSON.stringify(obj));
          return true;
        } catch (e) {
          console.error('sendIfOpen error', e);
          return false;
        }
      }

      // Display helpers
      function setStatus(text, isError = false) {
        status.textContent = text;
        status.style.color = isError ? 'var(--danger)' : 'var(--gray)';
      }

      function showLoading(msg = 'Loading...') {
        loading.style.display = 'flex';
        setStatus(msg);
      }

      function hideLoading() {
        loading.style.display = 'none';
      }

      // Format pairing code XXXX-XXXX for display (server returns 8 chars)
      function formatPairing(code) {
        if (!code) return '';
        const s = code.toString().toUpperCase().replace(/[^A-Z0-9]/g, '');
        return s.length === 8 ? `${s.slice(0,4)}-${s.slice(4)}` : s;
      }

      // Handle incoming WS messages
      function handleWSMessage(raw) {
        let message;
        try {
          message = JSON.parse(raw);
        } catch (e) {
          console.error('Invalid JSON from server', raw);
          return;
        }
        console.log('WS message:', message);

        switch (message.type) {
          case 'info':
            setStatus(message.message || 'Info');
            break;
          case 'qrcode':
            hideLoading();
            showQRCode(message.data);
            break;
          case 'pairing':
            hideLoading();
            showPairingCode(message.data);
            break;
          case 'session':
            // show session id
            sessionIdText.textContent = message.session || '';
            sessionIdDisplay.classList.add('active');
            break;
          case 'session_validation':
            handleSessionValidation(message);
            break;
          case 'connected':
            setStatus('Successfully connected!');
            // optionally show session
            if (message.session) {
              sessionIdText.textContent = message.session;
              sessionIdDisplay.classList.add('active');
            }
            break;
          case 'error':
            hideLoading();
            setStatus(message.message || 'Server error', true);
            break;
          default:
            console.warn('Unknown message type', message.type);
        }
      }

      // show QR
      function showQRCode(dataUrl) {
        pairingCodeEl.classList.remove('show');
        pairingCodeEl.textContent = '';
        qrcode.src = dataUrl;
        qrcode.classList.add('show');
        qrcode.style.display = 'block';
        setStatus('📲 Scan this QR Code with WhatsApp');
      }

      // show pairing code
      function showPairingCode(code) {
        qrcode.classList.remove('show');
        qrcode.src = '';
        qrcode.style.display = 'none';
        pairingCodeEl.textContent = formatPairing(code);
        pairingCodeEl.setAttribute('data-raw', code); // raw code for copy or usage
        pairingCodeEl.classList.add('show');
        pairingCodeEl.style.display = 'block';
        setStatus('🔑 Enter this pairing code in WhatsApp (or your bot)');

        // For convenience: automatically copy pairing code to clipboard (optional)
        // navigator.clipboard.writeText(code).catch(() => {});
      }

      // Validate session response
      function handleSessionValidation(msg) {
        if (msg.session !== sessionIdInput.value) return;
        validationSpinner.style.display = 'none';
        if (msg.valid) {
          sessionIdInput.classList.add('input-valid');
          sessionIdInput.classList.remove('input-invalid');
          validationMessage.textContent = 'Session valid';
          validationMessage.className = 'validation-message validation-success';
          isSessionValid = true;
        } else {
          sessionIdInput.classList.add('input-invalid');
          sessionIdInput.classList.remove('input-valid');
          validationMessage.textContent = msg.reason || 'Invalid session';
          validationMessage.className = 'validation-message validation-error';
          isSessionValid = false;
        }
        qrBtn.disabled = !isSessionValid && useCustomSession.checked;
        pairingBtn.disabled = !isSessionValid && useCustomSession.checked;
      }

      // ======= UI event wiring =======
      useCustomSession.addEventListener('change', function() {
        if (this.checked) {
          customSessionInput.classList.add('active');
          // require user to type session id to validate
          if (!sessionIdInput.value.trim()) {
            sessionIdInput.classList.add('input-invalid');
            validationMessage.textContent = 'Session ID is required';
            validationMessage.className = 'validation-message validation-error';
            isSessionValid = false;
            qrBtn.disabled = true;
            pairingBtn.disabled = true;
          } else {
            validateSessionId(sessionIdInput.value);
          }
        } else {
          customSessionInput.classList.remove('active');
          sessionIdInput.classList.remove('input-invalid', 'input-valid');
          validationMessage.textContent = '';
          qrBtn.disabled = false;
          pairingBtn.disabled = false;
        }
      });

      sessionIdInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          validateSessionId(this.value);
        }, 450);
      });

      qrBtn.addEventListener('click', () => startConnection('qrcode'));
      pairingBtn.addEventListener('click', () => startConnection('pairing'));
      resetBtn.addEventListener('click', resetAll);

      copySessionBtn.addEventListener('click', () => {
        const s = sessionIdText.textContent || '';
        if (!s) return;
        navigator.clipboard.writeText(s).then(() => {
          copySessionBtn.classList.add('copied');
          copySessionBtn.innerHTML = '<i class="fas fa-check"></i>';
          setTimeout(() => {
            copySessionBtn.classList.remove('copied');
            copySessionBtn.innerHTML = '<i class="far fa-copy"></i>';
          }, 1800);
        }).catch(() => setStatus('Unable to copy', true));
      });

      // Validate phone button
      validatePhone.addEventListener('click', () => {
        const phone = (phoneNumber.value || '').trim();
        if (!/^\d{8,15}$/.test(phone)) {
          setStatus('❌ Numéro invalide — entre 8 à 15 chiffres', true);
          phoneNumber.classList.add('input-invalid');
          return;
        }
        phoneNumber.classList.remove('input-invalid');
        showLoading('Generating Pairing Code...');
        const ok = sendIfOpen({
          type: 'request',
          content: 'pairing',
          data: { phoneNumber: phone, customSession: useCustomSession.checked ? (sessionIdInput.value || '').trim() : null }
        });
        if (!ok) hideLoading();
      });

      // Validate session id (client -> server)
      function validateSessionId(sessionId) {
        qrBtn.disabled = true;
        pairingBtn.disabled = true;
        validationSpinner.style.display = 'none';

        if (!useCustomSession.checked) {
          // not using custom session, nothing to do
          sessionIdInput.classList.remove('input-valid', 'input-invalid');
          validationMessage.textContent = '';
          isSessionValid = false;
          qrBtn.disabled = false;
          pairingBtn.disabled = false;
          return;
        }

        if (!sessionId || !sessionId.trim()) {
          sessionIdInput.classList.add('input-invalid');
          validationMessage.textContent = 'Session ID is required';
          validationMessage.className = 'validation-message validation-error';
          isSessionValid = false;
          return;
        }

        sessionIdInput.classList.remove('input-valid', 'input-invalid');
        validationSpinner.style.display = 'inline-block';
        validationMessage.textContent = 'Validating...';
        validationMessage.className = 'validation-message';

        const ok = sendIfOpen({ type: 'validate_session', sessionId: sessionId.trim() });
        if (!ok) {
          validationSpinner.style.display = 'none';
          validationMessage.textContent = 'Unable to validate (no server connection)';
          validationMessage.className = 'validation-message validation-error';
        }
      }

      // start connection flow
      function startConnection(type) {
        if (useCustomSession.checked && (!isSessionValid || !sessionIdInput.value.trim())) {
          setStatus('Please enter a valid session', true);
          sessionIdInput.classList.add('input-invalid');
          validationMessage.textContent = 'Invalid session';
          validationMessage.className = 'validation-message validation-error';
          sessionIdInput.focus();
          return;
        }

        // UI reset and state
        resetDisplay();
        currentConnectionType = type;
        connectionButtons.style.display = 'none';
        resetButton.style.display = 'flex';

        if (type === 'qrcode') {
          customSessionInput.classList.remove('active');
          phoneInput.classList.remove('active');
          showLoading('Generating QR Code...');
          const ok = sendIfOpen({ type: 'request', content: 'qrcode', data: { customSession: useCustomSession.checked ? (sessionIdInput.value||'').trim() : null } });
          if (!ok) hideLoading();
        } else if (type === 'pairing') {
          customSessionInput.classList.remove('active');
          phoneInput.classList.add('active');
          setStatus('Enter your phone number');
        }
      }

      // reset only display elements (keep socket)
      function resetDisplay() {
        qrcode.classList.remove('show');
        qrcode.style.display = 'none';
        qrcode.src = '';
        pairingCodeEl.classList.remove('show');
        pairingCodeEl.style.display = 'none';
        pairingCodeEl.textContent = '';
        sessionIdDisplay.classList.remove('active');
        phoneInput.classList.remove('active');
      }

      // reset everything and notify server to cancel
      function resetAll() {
        resetDisplay();
        useCustomSession.checked = false;
        customSessionInput.classList.remove('active');
        sessionIdInput.value = '';
        sessionIdInput.classList.remove('input-valid','input-invalid');
        phoneNumber.value = '';
        connectionButtons.style.display = 'flex';
        resetButton.style.display = 'none';
        setStatus('Select a login method');
        currentConnectionType = null;
        validationSpinner.style.display = 'none';
        validationMessage.textContent = '';
        validationMessage.className = 'validation-message';
        qrBtn.disabled = false;
        pairingBtn.disabled = false;
        sendIfOpen({ type: 'cancel' });
      }

      // Graceful close on page unload
      window.addEventListener('beforeunload', () => {
        try { if (ws && ws.readyState === WebSocket.OPEN) ws.close(); } catch (_) {}
      });

      // Expose a simple function for dev: simulate mobile completing pairing
      // (Not used automatically — useful for tests)
      window._simulateCompletePairing = function(pairingCodeRaw) {
        if (!pairingCodeRaw) pairingCodeRaw = pairingCodeEl.getAttribute('data-raw') || '';
        if (!pairingCodeRaw) return console.warn('No pairing code to simulate');
        // Create a temporary WS to server to mark pairing as completed (or reuse existing)
        const tmp = new WebSocket(wsUrl);
        tmp.addEventListener('open', () => {
          tmp.send(JSON.stringify({ type: 'complete_pairing', pairingCode: pairingCodeRaw }));
          setTimeout(()=> tmp.close(), 500);
        });
      };

      // initial status
      setStatus('Connecting to server...');

    }); // DOMContentLoaded end
  </script>
</body>
</html>